### 도커 스웜 데모
- [도커 스웜 데모](./docker-swarm-demo)

### 도커 명령어
|명령어|설명|비고|
|---|---|---|
|docker run [옵션] [이미지 이름]:[태그]|이미지를 컨테이너로 생성 후 실행||
|docker stop [컨테이너 ID]:[태그]|컨테이너 중지||
|docker start [컨테이너 ID]:[태그]|컨테이너 시작||
|docker attach [컨테이너 ID]:[태그]|실행되고 있는 컨테이너에 표준 입력(stdin)과 표준 출력(stdout)을 연결||
|docker exec|컨테이너에 접속 하여 특정 명령을 실행(/bin/bash), 접속 종료는 exit||
|docker images|도커 이미지 조회||
|docker search [이미지 이름]|도커 이미지 검색하기||
|docker pull [이미지 이름]:[태그]|도커 이미지 생성하기||
|docker rmi [이미지 ID]|도커 이미지 삭제하기||
|docker ps -a|도커 모든 컨테이너 목록 보기|-a 가 빠지면 현재 실행되고 있는 목록만 조회|
|docker container logs -t [컨테이너 ID]|로그 확인||
|docker rm [컨테이너 이름]|컨테이너 삭제||
|docker --help|명령어 확인||
|docker rename [기존 이름] [변경 할 이름]|컨테이너 이름 변경||

### 도커 옵션
|옵션|설명|비고|
|---|---|---|
|-d|백그라운드 모드||
|-p [호스트포트]:[컨테이너포트]|호스트와 컨테이너의 포트 연결(포트포워딩)||
|-v [호스트 폴더]:[컨테이너 폴더]|호스트와 컨테이너의 폴더 마운트(연결)||
|-e|컨테이너 내에서 사용 할 환경 변수 설정|Dockerfile의 ENV 설정도 덮어씌워짐|
|--name|컨테이너 이름 설정||
|-it|터미널 입력|쉘이나 CLI 도구를 사용할 때 유용함|
|-w|WORKDIR 설정을 덮어씌움||
|--entrypoint|Dockerfile의 ENTRYPOINT 설정을 덮어씌움||
|--rm|컨테이너 일회성 실행|컨테이너가 종료될 때 컨테이너와 관련된 리소스까지 제거됨|
|--link [컨테이너명]:[별칭]|컨테이너 연결||
|--restart|docker desktop을 실행 시킬 때마다 컨테이너를 자동으로 재시작 실행 여부|no: 컨테이너를 재시작 시키지 않음(default), on-failure:[max-retries]: 컨테이너가 정상적으로 종료되지 않은 경우 재시작 시킴. max-retires와 함께 옵션을 주면 최대 시도 횟수 설정, always: 컨테이너를 항상 재시작 시킴, unless-stopped: 컨테이너를 Stop 시키기 전까지 항상 재시작 시킴.|
|--log-opt max-size=100m --log-opt max-file=5|최대 100메가 크기의 5개의 로그 파일이 로그 로테이트 됨||

### 도커파일(DockerFile)
|명령어|설명|
|---|---|
|FROM|이미지를 생성 할 때 사용할 기반 이미지를 지정한다.|
|RUN|이미지를 생성 할 때 실행 할 코드를 지정한다.|
|WORKDIR|작업 폴더를 지정한다. 해당 작업 폴더가 존재하지 않는다면 새로 생성한다. 그 이후 명령어는 해당 작업 폴더 기준으로 동작한다.|
|COPY|파일이나 폴더를 이미지에 복사한다. 상대경로를 사용 할 경우 WORKDIR 로 지정한 폴더를 기준으로 복사한다.|
|ENV|이미지에서 사용 할 환경 변수 값을 지정한다. docker run 시 -- e 옵션을 활용하여 덮어 씌울 수 있다.|
|ARG|빌드 시점에만 사용되는 변수 값 이다. docker build 시 --build-arg 옵션을 활용하여 덮어 씌울 수 있다.|
|ENTRYPOINT|컨테이너를 구동 할 때 실행 할 명령어를 지정한다.|
|CMD|컨테이너를 구동 할 때 실행 할 명령어를 지정한다. 단 컨테이너를 실행 할 때 인자값을 주게 되면 Dockerfile 에 지정된 CMD 값을 대신 하여 지정한 인자값으로 변경하여 실행하게 된다.|


### 도커 스웜(Docker Swarm)
- 도커가 공식적으로 만든 오케스트레이션 툴이다.
- 오케스트레이션 이란?
  - 여러대의 서버와 여러 개의 서비스를 편리하게 관리해주는 작업 이다. 실제로는 스케줄링, 클러스터링, 서비스 디스커버리, 로깅, 모니터링 같은 일을 한다.
- 여러 호스트 서버의 컨테이너들을 배포 및 관리를 위한 툴이다.
- 다양한 기능을 지원한다.
  - 컨테이너 자동 배치 및 복제
  - 컨테이너 그룹에 대한 로드밸런싱
  - 컨테이너 장애 복구
  - 클러스터 외부에 서비스 노출
  - 컨테이너 추가 및 제거를 이용한 확장 및 축소
  - 컨테이너 서비스간의 인터페이스를 통한 연결 및 네트워크 포트 노출 및 제어
- 장점
  - 도커 명령어와 도커 컴포즈를 포함한 도커의 모든 기능이 내장되어 있다.
  - 도커 이외의 별도의 툴을 설치할 필요가 없다.
  - 타 오케스트레이션 툴에 비해 복잡하지 않고 다루기 쉽다.
- 단점
  - 타 오케스트레이션 툴에 비해 기능이 단순하여 세부적인 설정이 어렵다.
  - 초대형 노드 클러스터링에는 무리가 있다.
- 스웜 용어
  - Node: 스웜 클러스터에 속한 도커 서버의 단위이다. 한 서버에 하나의 도커 데몬만 실행하므로 서버가 곧 노드라고 이해하면 된다.
  - Manager Node: 스웜 클러스터 상태를 관리하는 노드이다. 매니저 노드는 곧 워커 노드가 될 수 있고, 스웜 명령어는 매니저 노드에서만 실행 가능하다.
  - Worker Node: 매니저 노드의 명령을 받아 컨테이너를 생성하고 상태를 체크하는 노드이다.
  - Service: 기본적인 배포 단위이다. 하나의 서비스는 하나의 이미지를 기반으로 생성하고 동일한 컨테이너를 한개 이상 실행 할 수 있다.
  - Task: 컨테이너 배포 단위이다. 하나의 서비스는 여러개의 Task를 실행 할 수 있고 각각의 Task가 컨테이너를 관리한다.
- 스웜에서 제공하는 기능
  - 스케줄링
  - 고가용성
  - 멀티 호스트 네트워크
  - 서비스 디스커버리
  - 순차적 업데이트
  - 상태체크
  - 비밀값 저장
  - 로깅
  - 모니터링
  - 크론(반복작업)

### 도커 스웜 데모
- [도커 스웜 데모](./docker-swarm-demo)

### 오버레이 네트워크
- docker network ls 명령어는 네트워크 목록을 보여준다.
- 오버레이 네트워크 중 ingress 네트워크는 호스트(노드)에서 서비스로의 포워딩을 담당한다.
- 외부에 포트를 공개한 서비스를 스웜에 배포하면 ingress 네트워크에 서비스를 참여시키고 다음 두 IP를 할당한다.
  - 서비스에 대한 가상 IP
  - 서비스의 각 컨테이너에 대한 IP
- 각 노드는 외부에 개시된 서비스 포트로 요청이 오면 ingress 네트워크의 가상 IP로 전달한다.
- 가상 IP는 ingress 네트워크에서 서비스에 접근할 때 사용 할 IP 이다.
- 가상 IP에 전달된 요청은 다시 컨테이너의 IP로 전달된다.
- ingress 네트워크에 참여한 서비스의 각 컨테이너는 ingress 네트워크 내에서 고유 IP를 찾는다.
- docker network inspect ingress 명령어를 실행하면 ingress 네트워크 내에 생성된 서비스의 VIP와 각 컨테이너에 할당된 IP를 확인 할 수 있다.
- docker_gwbridge 네트워크는 docker swarm을 init 하거나 join 할때 생성된다.
- Service가 실행 중인 각각의 컨테이너는 로컬의 docker_gwbridge에 연결이 된다.
- 오버레이 네트워크는 도커 스웜에 참여하는 도커 데몬간의 통신을 관리한다.
- 생성된 오버레이 네트워크는 스웜 서비스를 연결시켜 서비스간에 통신을 활성화 할 수 있다. 이러한 오버레이 네트워크는 Overlay Network Driver 를 사용한다.
- 오버레이 네트워크를 사용하면 컨테이너는 외부에 포트를 오픈하지 않아도 되고 연결되는 다른 컨테이너와 다른 노드에 있어도 같은 서버에 있는것 처럼 통신할 수 있다.

### Fluentd
- 로그 수집기 이다. 
- 다양한 데이터 소스(HTTP, TCP 등등..)로 부터 데이터를 받아 올 수 있다.
- Fluentd로 전달된 데이터는 tag, time, record(JSON) 로 구성된 이벤트로 처리되며, 원하는 형태로 가공되어 다양한 목적지로 전달 될 수 있다.
  - tag: 이벤트를 어디로 보낼지 결정하기 위한 구분값
  - time: 이벤트가 발생한 시간
  - record: 데이터(JSON)
- 데이터 유실을 막기 위해 메모리와 파일 기반의 버퍼 시스템을 갖고 있으며, Failover를 위한 HA(High Availability) 구성도 가능하다.
- Fluentd 는 Input, Parser, Engine, Filter, Buffer, Output, Formatter 7개의 컴포넌트로 구성되어 있다.
- 일반적인 데이터 흐름은 Input -> Engine -> Output 이고 그 외(Parser, Buffer, Filter, Formatter 등)에는 설정에 따라서 선택적으로 추가 또는 삭제가 가능하다.

### 참고
- [도커 네트워크 요약](https://jonnung.dev/docker/2020/02/16/docker_network/)